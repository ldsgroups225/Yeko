# Yeko Core App — Agent Guide

> **Admin dashboard** for the Yeko platform. Manages schools, programs, catalogs, fee templates, users, and platform-wide analytics.
> Deployed to **Cloudflare Workers** via Wrangler. SSR powered by **TanStack Start**.

See @../../AGENTS.md for project-wide rules, security protocols, and the Result-oriented framework.
See @../../.kiro/steering/project_constitution.md for architectural decisions.
See @../../.kiro/steering/dev_coder_steering.md for coding standards.

---

## Quick Reference

| Action | Command |
| --- | --- |
| Dev server | `pnpm dev` (port 3000) |
| Build | `pnpm build` |
| Deploy | `pnpm deploy` |
| Typecheck | `pnpm typecheck` |
| Lint + fix | `pnpm lint:fix` |
| Unit tests | `pnpm test` |
| E2E tests | `pnpm exec playwright test` |
| CF type gen | `pnpm cf-typegen` |
| Unused code | `pnpm knip` |

---

## Tech Stack

- **SSR Framework:** TanStack Start + TanStack Router (file-based routing)
- **UI:** React 19, shadcn/ui (`@workspace/ui`), Tailwind CSS v4, `motion/react`
- **State:** TanStack Query v5
- **Auth:** Better Auth (cookie prefix: `core`)
- **Data:** `@repo/data-ops` (Drizzle ORM, Neon serverless PostgreSQL)
- **i18n:** typesafe-i18n (base locale: `fr`, output: `src/i18n/`)
- **Icons:** `@tabler/icons-react`
- **Validation:** Zod
- **Excel export:** `@chronicstone/typed-xlsx` + `xlsx`
- **Drag & drop:** `@dnd-kit/core` + `@dnd-kit/sortable`
- **Payments:** Polar.sh integration
- **Bundle analysis:** `rollup-plugin-visualizer` (outputs `stats.html`)
- **Testing:** Vitest (JSDOM) + Playwright (E2E)

---

## Directory Structure

```text
src/
├── server.ts              # CF Worker entry — inits DB, sets auth (cookiePrefix: 'core')
├── start.tsx              # TanStack Start config
├── router.tsx             # TanStack Router instance
├── routeTree.gen.ts       # ⚠️ AUTO-GENERATED — do not edit
├── styles.css             # Tailwind entry
│
├── routes/
│   ├── __root.tsx          # Root layout (meta, theme, i18n, devtools)
│   ├── index.tsx           # Landing / redirect
│   ├── demo-request.tsx    # Public demo page
│   ├── unauthorized.tsx    # Unauthorized page
│   ├── api/                # API routes (auth handler)
│   └── _auth/              # Authenticated routes
│       └── ...             # Dashboard, schools, programs, etc.
│
├── core/
│   ├── functions/          # Server functions (createServerFn + Zod validation)
│   │   ├── catalogs.ts     # Catalog CRUD
│   │   ├── programs.ts     # Program management
│   │   ├── schools.ts      # School CRUD
│   │   ├── coefficients.ts # Coefficient management
│   │   ├── payments.ts     # Payment operations
│   │   ├── fee-type-templates.ts
│   │   ├── storage.ts      # File upload/download
│   │   └── ...
│   └── middleware/         # Auth + context middleware
│
├── components/             # UI components organized by feature
├── hooks/                  # Custom React hooks
├── schemas/                # Zod schemas for form validation
├── i18n/                   # typesafe-i18n translations (fr base)
├── integrations/           # External service integrations (Polar.sh)
├── lib/                    # Utilities, query keys, helpers
├── constants/              # App constants
├── mocks/                  # Test mocks
├── test/                   # Test utilities and setup
└── utils/                  # General utility functions
```

---

## Critical Conventions

### Server Functions

All server functions live in `src/core/functions/` and follow this pattern:

```typescript
import { createServerFn } from '@tanstack/react-start'
import { zodValidator } from '@tanstack/zod-form-adapter'

export const myAction = createServerFn()
  .inputValidator(zodSchema)
  .handler(async ({ data }) => {
    const result = await dataOpsQuery(data)
    if (R.isFailure(result)) {
      return { success: false, error: result.error.message }
    }
    return { success: true, data: result.value }
  })
```

### Auth Context

- Cookie prefix: **`core`** (set in `server.ts`)
- Google OAuth + email/password enabled
- Auth gate at `_auth` route layout

### i18n

- Library: **typesafe-i18n** (`LL.key()` pattern)
- Base locale: `fr` (French)
- Config: `.typesafe-i18n.json`
- Output: `src/i18n/`
- ⚠️ Do NOT edit auto-generated `i18n-types.ts` or `i18n-util.ts`

### Vite SSR/Client Split

The `vite.config.ts` contains two critical custom plugins:

- **`dataOpsBrowserGuard`** — redirects `@repo/data-ops` to `index.browser.ts` on client builds
- **`stubServerModulesForClient`** — stubs `database/setup.ts` and `node:crypto` for client

Never import `@repo/data-ops` server-only modules in client components.

---

## Do NOT

- ❌ Edit `routeTree.gen.ts` — auto-generated by TanStack Router
- ❌ Edit `i18n-types.ts` — auto-generated by typesafe-i18n
- ❌ Import `@repo/data-ops` server modules in client components
- ❌ Use `domMax` from `motion/react` — use `domAnimation`
- ❌ Hardcode UI strings — use `LL.key()`
- ❌ Throw raw exceptions in server functions — return `{ success: false, error }`
- ❌ Query without `schoolId` scoping on school-level data
