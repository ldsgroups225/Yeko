# Yeko Teacher App — Agent Guide

> **Teacher-facing dashboard** for managing classes, attendance, grades, homework, messaging, and schedules.
> Deployed to **Cloudflare Workers** via Wrangler. SSR powered by **TanStack Start**.

See @../../AGENTS.md for project-wide rules, security protocols, and the Result-oriented framework.
See @../../.kiro/steering/project_constitution.md for architectural decisions.
See @../../.kiro/steering/dev_coder_steering.md for coding standards.

---

## Quick Reference

| Action | Command |
| --- | --- |
| Dev server | `pnpm dev` (port 3002) |
| Build | `pnpm build` |
| Deploy | `pnpm deploy` |
| Typecheck | `pnpm typecheck` |
| Lint + fix | `pnpm lint:fix` |
| Unit tests | `pnpm test` |
| Test coverage | `pnpm test:coverage` |
| CF type gen | `pnpm cf-typegen` |

---

## Tech Stack

- **SSR Framework:** TanStack Start + TanStack Router (file-based routing)
- **UI:** React 19, shadcn/ui (`@workspace/ui`), Tailwind CSS v4, `motion/react`
- **State:** TanStack Query v5, TanStack Virtual (virtualized lists)
- **Local-first drafts:** PGlite (`@electric-sql/pglite`) for offline grade drafts
- **Auth:** Better Auth (cookie prefix: `teacher`)
- **Data:** `@repo/data-ops` (Drizzle ORM, Neon serverless PostgreSQL)
- **i18n:** typesafe-i18n (base locale: `fr`, output: `src/i18n/`)
- **Icons:** `@tabler/icons-react`
- **Validation:** Zod, `@hookform/resolvers`
- **Testing:** Vitest (JSDOM)

---

## Directory Structure

```text
src/
├── server.ts              # CF Worker entry — inits DB, sets auth (cookiePrefix: 'teacher')
├── start.tsx              # TanStack Start config
├── router.tsx             # TanStack Router instance
├── routeTree.gen.ts       # ⚠️ AUTO-GENERATED — do not edit
├── styles.css             # Tailwind entry
│
├── routes/                # File-based routes (~27 files)
│   ├── __root.tsx
│   ├── _auth/             # Authenticated routes
│   │   ├── dashboard/
│   │   ├── classes/
│   │   ├── attendance/
│   │   ├── grades/
│   │   ├── homework/
│   │   ├── messages/
│   │   └── schedule/
│   └── ...
│
├── teacher/
│   ├── functions/         # Server functions (~14 domain files)
│   │   ├── attendance.ts
│   │   ├── classes.ts
│   │   ├── dashboard.ts
│   │   ├── grades.ts
│   │   ├── homework.ts
│   │   ├── messages.ts
│   │   ├── notifications.ts
│   │   ├── parents.ts
│   │   ├── participation.ts
│   │   ├── schedule.ts
│   │   ├── sessions.ts
│   │   ├── student-notes.ts
│   │   └── users.ts
│   └── middleware/
│
├── components/            # UI components (~37 files)
├── hooks/                 # Custom React hooks (~10 files)
├── schemas/               # Zod schemas (~4 files)
├── i18n/                  # typesafe-i18n translations
├── integrations/          # External service integrations
├── lib/                   # Utilities, query keys (~26 files)
├── __tests__/             # Test files (~5 files)
├── constants/             # App constants
└── utils/                 # General utility functions
```

---

## Critical Conventions

### Server Functions

All server functions live in `src/teacher/functions/` — organized by feature domain:

```typescript
export const getTeacherClasses = createServerFn()
  .handler(async () => {
    const ctx = await getTeacherContext()
    const result = await dataOpsQuery(ctx.teacherId)
    // ...
  })
```

### Auth Context

- Cookie prefix: **`teacher`** (set in `server.ts`)
- Google OAuth + email/password enabled
- Auth gate at `_auth` route layout

### PGlite (Local-First Drafts)

This app uses **PGlite** for offline-capable grade draft persistence. Grades are stored locally in the browser until the teacher explicitly publishes them.

Key patterns:

- Drafts persist in PGlite (IndexedDB-backed PostgreSQL in the browser)
- "Publish" action syncs drafts to the server via server functions
- See KI: "Persistent Grading Workflow Patterns in Yeko"

### i18n

- Library: **typesafe-i18n** (`LL.key()` pattern)
- Base locale: `fr` (French)
- Config: `.typesafe-i18n.json`
- Output: `src/i18n/`

---

## Do NOT

- ❌ Edit `routeTree.gen.ts` — auto-generated by TanStack Router
- ❌ Edit `i18n-types.ts` — auto-generated by typesafe-i18n
- ❌ Import `@repo/data-ops` server modules in client components
- ❌ Use `domMax` from `motion/react` — use `domAnimation`
- ❌ Hardcode UI strings — use `LL.key()`
- ❌ Throw raw exceptions in server functions
- ❌ Delete `.tsbuildinfo` files in `teacher/functions/` — they are build cache
