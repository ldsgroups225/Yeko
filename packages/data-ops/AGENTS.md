# @repo/data-ops — Agent Guide

> **Shared data layer** for the Yeko monorepo. Contains auth configuration, database setup, Drizzle ORM schemas, query modules, Zod schemas, S3 storage, and i18n translations.
> Built with `tsc` + `tsc-alias`. Consumed by all apps.

See @../../AGENTS.md for project-wide rules, the Result-oriented framework, and security protocols.

---

## Quick Reference

| Action | Command |
| --- | --- |
| Build | `pnpm build` |
| Typecheck | `pnpm typecheck` |
| Lint + fix | `pnpm lint:fix` |
| Unit tests | `pnpm test` |
| Unit tests (watch) | `pnpm test:watch` |
| Generate Drizzle migrations | `pnpm drizzle:generate` |
| Run migrations | `pnpm drizzle:migrate` |
| Pull schema from DB | `pnpm drizzle:pull` |
| Drizzle Studio | `pnpm studio` |
| Generate Better Auth schema | `pnpm better-auth:generate` |
| Seed database | `pnpm seed` |
| Seed (fresh — drops + recreates) | `pnpm seed:fresh` |
| Reset database | `pnpm reset:db` |

---

## Directory Structure

```text
src/
├── index.ts               # Main server export (default entrypoint)
├── index.browser.ts       # Browser-safe export (client-side re-exports)
├── errors.ts              # DatabaseError type definition
├── verify.ts              # Build verification script
│
├── auth/
│   ├── server.ts          # Better Auth instance (setAuth, getAuth)
│   └── setup.ts           # Auth configuration factory
│
├── database/
│   └── setup.ts           # initDatabase, getDb — Neon/pg driver selection
│
├── drizzle/
│   ├── auth-schema.ts     # ⚠️ AUTO-GENERATED by Better Auth CLI
│   ├── schema.ts          # Main schema barrel export
│   └── *.ts               # Table definitions (students, schools, classes, etc.)
│
├── queries/
│   ├── *.ts               # Domain query modules (~65 files)
│   └── shared/            # Shared query utilities
│
├── zod-schema/
│   └── *.ts               # Shared Zod validation schemas
│
├── storage/
│   ├── index.ts           # S3-compatible file storage (R2)
│   └── ...
│
├── i18n/
│   └── *.ts               # Shared i18n translations
│
├── seed/
│   ├── index.ts           # Main seed entry (--fresh flag support)
│   ├── reset-db.ts        # Database reset script
│   └── *.ts               # Domain-specific seed data files
│
├── services/              # Business logic services
├── schemas/               # Internal schemas
├── utils/                 # Utility functions
└── tests/                 # Test files (~22 files)

config/
└── auth.ts                # Better Auth CLI config

drizzle.config.ts           # Drizzle Kit config (migrations)
migrations/                 # Generated migration files
```

---

## Export Map

This package uses conditional exports for SSR/client split:

| Export Path | Purpose |
| --- | --- |
| `@repo/data-ops` | Main: `index.ts` (server) / `index.browser.ts` (client via Vite plugin) |
| `@repo/data-ops/auth/server` | Better Auth instance |
| `@repo/data-ops/auth/setup` | Auth configuration |
| `@repo/data-ops/database/*` | DB initialization |
| `@repo/data-ops/queries/*` | Domain query modules |
| `@repo/data-ops/drizzle/*` | Drizzle schema tables |
| `@repo/data-ops/zod-schema/*` | Shared Zod schemas |
| `@repo/data-ops/errors` | `DatabaseError` type |
| `@repo/data-ops/storage` | S3-compatible file storage |
| `@repo/data-ops/services/*` | Business logic services |

---

## Critical Conventions

### No-Throw Policy (MANDATORY)

Every query function MUST return `ResultAsync<T, DatabaseError>`:

```typescript
import { ResultAsync } from '@praha/byethrow'
import { tapLogErr } from '@repo/logger'

export function getStudentsBySchool(db: Database, schoolId: string) {
  return ResultAsync.fromPromise(
    db.select().from(students).where(eq(students.schoolId, schoolId)),
    (error) => new DatabaseError('getStudentsBySchool', error)
  ).mapErr(tapLogErr(databaseLogger, 'getStudentsBySchool'))
}
```

### Multi-Tenant Isolation (CRITICAL)

Every query on school-scoped tables MUST include:

```typescript
where(eq(table.schoolId, schoolId))
```

### SSR/Client Split

- `index.ts` — full server exports (auth, DB, queries, etc.)
- `index.browser.ts` — client-safe re-exports (Zod schemas, types, constants only)
- Apps use Vite plugins to redirect `@repo/data-ops` → `index.browser.ts` on client builds

### Database Driver

- Neon HTTP driver is auto-selected for URLs containing `.neon.tech` or `sslmode=`
- Standard `pg` driver for local/other connections
- ❌ **No transactions** with Neon HTTP — use sequential operations

### Seeding

- Seeds use `onConflictDoNothing()` for idempotency
- `pnpm seed:fresh` drops all data and re-seeds
- Seed files organized by domain in `src/seed/`

### Migrations

After schema changes:

1. `pnpm drizzle:generate` — generates SQL migration
2. Review the generated SQL in `migrations/`
3. `pnpm drizzle:migrate` — applies to database

---

## Do NOT

- ❌ Throw raw exceptions — wrap in `DatabaseError` and return `ResultAsync`
- ❌ Skip `tapLogErr` on ResultAsync chains
- ❌ Query school data without `schoolId` filter
- ❌ Edit `auth-schema.ts` manually — generated by `pnpm better-auth:generate`
- ❌ Use transactions with Neon HTTP driver
- ❌ Import server-only modules (`database/setup`, `auth/server`) in client code
- ❌ Add browser-incompatible imports (e.g., `node:crypto`) without handling in Vite plugins
