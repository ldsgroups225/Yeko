pre-commit:
  parallel: true

  jobs:
    - name: "ESLint (staged files with per-package configs)"
      run: |
        # Get unique parent directories (apps/*, packages/*) from staged files
        for file in {staged_files}; do
          dir="$(dirname "$file")"
          # Find the package root (apps/* or packages/*)
          while [ "$dir" != "." ] && [ "$dir" != "/" ]; do
            if [ -f "$dir/package.json" ] && [ -f "$dir/eslint.config.js" ]; then
              echo "$dir"
              break
            fi
            dir="$(dirname "$dir")"
          done
        done | sort -u | while read pkg_dir; do
          # Run eslint from each package directory with its own config
          (cd "$pkg_dir" && pnpm exec eslint . --fix --quiet) &
        done
        wait
      glob:
        - "**/*.ts"
        - "**/*.tsx"
        - "**/*.js"
        - "**/*.jsx"
      stage_fixed: true
      skip_empty: true

    - name: "TypeScript (staged files with per-package configs)"
      run: |
        # Get unique parent directories from staged files
        for file in {staged_files}; do
          dir="$(dirname "$file")"
          while [ "$dir" != "." ] && [ "$dir" != "/" ]; do
            if [ -f "$dir/package.json" ] && [ -f "$dir/tsconfig.json" ]; then
              echo "$dir"
              break
            fi
            dir="$(dirname "$dir")"
          done
        done | sort -u | while read pkg_dir; do
          # Run tsc from each package directory with its own config
          (cd "$pkg_dir" && pnpm exec tsc --noEmit) &
        done
        wait
      glob:
        - "**/*.ts"
        - "**/*.tsx"
      skip_empty: true
      allow_empty: true

    # - name: "Prettier (format unformatted files)"
    #   run: pnpm exec prettier --write {staged_files}
    #   glob:
    #     - "**/*.ts"
    #     - "**/*.tsx"
    #     - "**/*.js"
    #     - "**/*.jsx"
    #     - "**/*.css"
    #     - "**/*.json"
    #     - "**/*.yaml"
    #     - "**/*.yml"
    #     - "**/*.md"
    #   stage_fixed: true
    #   skip_empty: true

# Pre-push hook - runs before code is pushed to remote
# More comprehensive checks since this is before shared history
pre-push:
  parallel: false
  jobs:
    # Full lint check on all files in the push
    - name: "Full ESLint Check"
      run: pnpm lint:check
      description: "Run full lint check on all packages"
      allow_empty: true

    # Full typecheck on all packages
    - name: "Full TypeScript Check"
      run: pnpm typecheck
      description: "Run full TypeScript check on all packages"
      allow_empty: true

# Commit-msg hook - validate commit messages
# Uncomment to enable conventional commits validation
# commit-msg:
#   parallel: true
#   jobs:
#     - name: "Validate Commit Message"
#       run: pnpm exec commitlint --edit "$1"
#       glob:
#         - "**/*.js"
#         - "**/*.ts"

# Post-merge hook - run after git merge
# Reinstall dependencies if package.json changed
post-merge:
  parallel: true
  jobs:
    - name: "Install Dependencies (if package.json changed)"
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -q "package.json\|pnpm-lock.yaml"; then
          pnpm install
        fi
      glob:
        - "**/package.json"
        - "**/pnpm-lock.yaml"
      skip_empty: true

# Post-checkout hook - run after git checkout
# Useful for ensuring dependencies are up to date
post-checkout:
  parallel: true
  jobs:
    - name: "Install Dependencies (if needed)"
      run: |
        if [ ! -d "node_modules" ] || [ ! -d "packages/data-ops/node_modules" ]; then
          pnpm install
        fi
      skip_empty: true

# Custom hooks - can be run manually with `lefthook run <hook-name>`

# Run with: lefthook run auto-fix
auto-fix:
  jobs:
    - name: "Auto-fix all issues"
      run: pnpm lint:fix
      description: "Run lint:fix across all packages"

# Run with: lefthook run typecheck-all
typecheck-all:
  jobs:
    - name: "Full TypeScript Check"
      run: pnpm typecheck
      description: "Run typecheck across all packages"
