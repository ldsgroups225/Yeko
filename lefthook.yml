# â”€â”€â”€ Output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
output:
  - meta
  - summary
  - success
  - failure
  - execution_out

# â”€â”€â”€ Pre-commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runs ESLint (fix) + TypeScript check in parallel, per-package.
# Only packages with staged files are checked (skip_empty).
pre-commit:
  parallel: true
  exclude:
    - '**/routeTree.gen.ts'
    - '**/i18n-types.ts'
    - '**/i18n-util.ts'
    - '**/auth-schema.ts'

  jobs:
    # â”€â”€ ESLint (auto-fix staged files) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: eslint
      group:
        parallel: true
        glob: '*.{ts,tsx,js,jsx}'
        jobs:
          # Apps
          - name: 'eslint:core'
            root: apps/core/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in apps/core
          - name: 'eslint:school'
            root: apps/school/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in apps/school
          - name: 'eslint:teacher'
            root: apps/teacher/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in apps/teacher
          - name: 'eslint:data-service'
            root: apps/data-service/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in apps/data-service
          # Packages
          - name: 'eslint:data-ops'
            root: packages/data-ops/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/data-ops
          - name: 'eslint:ui'
            root: packages/ui/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/ui
          - name: 'eslint:logger'
            root: packages/logger/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/logger
          - name: 'eslint:background-tasks'
            root: packages/background-tasks/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/background-tasks
          - name: 'eslint:queue-worker'
            root: packages/queue-worker/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/queue-worker
          - name: 'eslint:eslint-config'
            root: packages/eslint-config/
            run: pnpm exec eslint {staged_files} --fix --quiet
            stage_fixed: true
            skip_empty: true
            fail_text: ESLint failed in packages/eslint-config

    # â”€â”€ TypeScript (noEmit check) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: typecheck
      group:
        parallel: true
        glob: '*.{ts,tsx}'
        jobs:
          # Apps
          - name: 'tsc:core'
            root: apps/core/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in apps/core
          - name: 'tsc:school'
            root: apps/school/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in apps/school
          - name: 'tsc:teacher'
            root: apps/teacher/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in apps/teacher
          - name: 'tsc:data-service'
            root: apps/data-service/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in apps/data-service
          # Packages
          - name: 'tsc:data-ops'
            root: packages/data-ops/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in packages/data-ops
          - name: 'tsc:ui'
            root: packages/ui/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in packages/ui
          - name: 'tsc:logger'
            root: packages/logger/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in packages/logger
          - name: 'tsc:background-tasks'
            root: packages/background-tasks/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in packages/background-tasks
          - name: 'tsc:queue-worker'
            root: packages/queue-worker/
            run: pnpm exec tsc --noEmit
            skip_empty: true
            fail_text: TypeScript errors in packages/queue-worker

# â”€â”€â”€ Pre-push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Full checks before sharing code â€” lint + typecheck can run in parallel.
pre-push:
  parallel: true
  jobs:
    - name: Full ESLint Check
      run: pnpm lint:check
      fail_text: Fix lint errors before pushing
    - name: Full TypeScript Check
      run: pnpm typecheck
      fail_text: Fix type errors before pushing

# â”€â”€â”€ Post-merge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Reinstall dependencies when lockfile or package.json changed.
post-merge:
  jobs:
    - name: Install Dependencies
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -qE "(^|/)package\.json$|pnpm-lock\.yaml$"; then
          echo "ðŸ“¦ Dependencies changed â€” running pnpm install..."
          pnpm install
        fi

# â”€â”€â”€ Post-checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ensure node_modules exist after branch switch.
post-checkout:
  jobs:
    - name: Install Dependencies (if missing)
      run: |
        if [ ! -d "node_modules" ] || [ ! -d "packages/data-ops/node_modules" ]; then
          echo "ðŸ“¦ node_modules missing â€” running pnpm install..."
          pnpm install
        fi

# â”€â”€â”€ Custom hooks (run manually) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usage: lefthook run auto-fix
auto-fix:
  jobs:
    - name: Auto-fix all issues
      run: pnpm lint:fix

# Usage: lefthook run typecheck-all
typecheck-all:
  jobs:
    - name: Full TypeScript Check
      run: pnpm typecheck
